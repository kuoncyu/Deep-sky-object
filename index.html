<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>ğŸŒŒ å®‡å®™å…¨æ›¸ï¼šå®Œç¾çµ‚ç«  (Audio Enhanced)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f3ff;
            --secondary: #9d00ff;
            --glass: rgba(8, 14, 24, 0.95);
            --border: rgba(0, 243, 255, 0.4);
            --text: #e0e6ed;
            --danger: #ff3366;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: #000;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
            background-image: radial-gradient(circle at 50% 50%, #050508 0%, #000 100%);
            user-select: none;
        }

        /* æ˜Ÿç©ºæ¼‚æµ®å‹•ç•« */
        .stars {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-image: 
                radial-gradient(1px 1px at 20px 20px, #fff, transparent),
                radial-gradient(2px 2px at 100px 200px, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 300px 400px, rgba(255,255,255,0.3), transparent);
            background-size: 600px 600px;
            animation: drift 100s linear infinite;
        }
        @keyframes drift { from { background-position: 0 0; } to { background-position: 0 600px; } }

        .container {
            background: var(--glass);
            border: 1px solid var(--border);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 0 80px rgba(0, 243, 255, 0.15);
            max-width: 650px;
            width: 100%;
            text-align: center;
            position: relative;
            backdrop-filter: blur(12px);
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            margin: 0 0 10px 0; font-size: 2em;
            background: linear-gradient(90deg, #fff, var(--primary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 243, 255, 0.5);
        }

        /* é ‚éƒ¨å·¥å…·åˆ— */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; position: relative;
        }

        /* ğŸ  æ”¾æ£„ä»»å‹™æŒ‰éˆ• */
        .btn-abort {
            background: rgba(255, 51, 102, 0.1); border: 1px solid rgba(255, 51, 102, 0.4);
            color: #ff5577; padding: 5px 12px; border-radius: 20px; cursor: pointer;
            font-size: 0.8em; font-weight: bold; transition: 0.3s;
            display: flex; align-items: center; gap: 5px;
        }
        .btn-abort:hover { background: rgba(255, 51, 102, 0.3); box-shadow: 0 0 10px rgba(255, 51, 102, 0.3); color: #fff; }

        /* ğŸ”Š éŸ³æ•ˆç‹€æ…‹ç‡ˆ */
        .audio-wave {
            color: var(--primary); font-size: 0.75em; letter-spacing: 1px;
            border: 1px solid var(--primary); padding: 4px 10px;
            border-radius: 20px; cursor: pointer; opacity: 0.6;
            background: rgba(0,0,0,0.5);
        }
        .audio-wave.active { opacity: 1; box-shadow: 0 0 15px var(--primary); background: rgba(0, 243, 255, 0.1); }

        /* ğŸ“Š HUD è¨ˆåˆ†æ¿ */
        .hud {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.06); padding: 12px 25px; border-radius: 12px;
            margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);
        }
        .hud-item { display: flex; flex-direction: column; align-items: flex-start; }
        .hud-item:last-child { align-items: flex-end; }
        .hud-lbl { font-size: 0.7em; color: #888; letter-spacing: 2px; }
        .hud-val { font-family: 'Orbitron', sans-serif; font-size: 1.5em; font-weight: bold; color: var(--primary); }

        /* åœ–ç‰‡å€ */
        .viewport {
            position: relative; width: 100%; height: 380px;
            background: #000; border-radius: 16px; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.15); margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center;
        }
        .target-img {
            max-width: 100%; max-height: 100%; 
            width: auto; height: auto;
            object-fit: contain; 
            opacity: 0; transition: opacity 0.4s ease;
        }
        
        .loader {
            position: absolute; display: flex; flex-direction: column; align-items: center;
            color: var(--primary); font-size: 0.9em; letter-spacing: 3px; font-family: 'Orbitron';
        }
        .scan-line {
            width: 100%; height: 2px; background: var(--primary);
            position: absolute; top: 0; animation: scan 1.5s infinite linear;
            box-shadow: 0 0 10px var(--primary);
        }
        @keyframes scan { 0% { top: 0; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        /* æŒ‰éˆ•ç¾¤ */
        .btn {
            border: none; padding: 16px; border-radius: 8px; cursor: pointer;
            font-family: inherit; font-weight: bold; font-size: 1em; transition: 0.2s;
            width: 100%; position: relative; overflow: hidden;
        }
        .btn-main {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: #fff; font-size: 1.2em; box-shadow: 0 0 25px rgba(0, 243, 255, 0.25);
        }
        .btn-main:hover { transform: scale(1.02); box-shadow: 0 0 40px rgba(0, 243, 255, 0.5); }

        .btn-report {
            background: transparent; border: 1px dashed rgba(255,255,255,0.2); 
            color: rgba(255,255,255,0.5); font-size: 0.85em; padding: 8px;
            margin-bottom: 15px;
        }
        .btn-report:hover { border-color: #ff3366; color: #ff3366; }

        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn-opt {
            background: rgba(255,255,255,0.05); color: var(--text); 
            border: 1px solid rgba(255,255,255,0.15);
            padding: 15px 5px; min-height: 65px;
            display: flex; align-items: center; justify-content: center; text-align: center;
            line-height: 1.3; font-size: 0.95em;
        }
        .btn-opt:hover:not(:disabled) {
            background: rgba(0, 243, 255, 0.15); border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.1);
        }
        .btn-opt:disabled { opacity: 0.5; cursor: default; }

        /* å›é¥‹å€ */
        .feedback {
            margin-top: 20px; padding: 15px; border-radius: 10px; text-align: left;
            background: rgba(0, 243, 255, 0.1); border-left: 4px solid var(--primary);
            display: none; animation: slideIn 0.3s;
        }
        .feedback.wrong { background: rgba(255, 0, 85, 0.1); border-left-color: #ff3366; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .slider-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin: 20px 0; }
        input[type=range] { width: 100%; accent-color: var(--primary); margin-top: 10px; }

    </style>
</head>
<body onclick="soundSys.unlock()">

<div class="stars"></div>

<div id="view-setup" class="container">
    <h1>UNIVERSE <span style="font-size:0.5em; opacity:0.7;">FINAL</span></h1>
    <p style="color:#aaa; letter-spacing:1px; margin-top:5px;">å®‡å®™å…¨æ›¸å®Œç¾ç‰ˆ (Audio Enhanced)</p>

    <div style="text-align:left; background:rgba(0,0,0,0.4); padding:20px; border-radius:10px; margin:25px 0; border:1px dashed rgba(255,255,255,0.2); line-height:1.7; font-size:0.9em;">
        <strong>ğŸ“¡ ç³»çµ±å°±ç·’ï¼š</strong><br>
        1. <strong>ğŸµ æ·±ç©ºéŸ³é »å¼•æ“ï¼š</strong> æ­è¼‰ Generative Space Ambientï¼Œéš¨æ©Ÿç”Ÿæˆä¸é‡è¤‡çš„å®‡å®™èƒŒæ™¯éŸ³ã€‚<br>
        2. <strong>ğŸŒŒ æ²‰æµ¸é«”é©—ï¼š</strong> åŒ…å« Drone (ä½é »)ã€Pad (ç©ºéˆé•·éŸ³) èˆ‡ Twinkle (æ˜Ÿå…‰)ã€‚<br>
        3. <strong>ğŸ  è‡ªç”±é€²é€€ï¼š</strong> éš¨æ™‚å¯è¿”å›åŸºåœ°ã€‚
    </div>

    <div class="slider-box">
        <div style="display:flex; justify-content:space-between; align-items:end;">
            <label>ä»»å‹™æ•¸é‡</label>
            <span id="q-val" style="color:var(--primary); font-size:1.5em; font-family:'Orbitron';">20</span>
        </div>
        <input type="range" id="q-range" min="10" max="100" value="20" oninput="document.getElementById('q-val').innerText=this.value">
    </div>

    <button class="btn btn-main" onclick="game.start()">å•Ÿå‹•ä»»å‹™ (START)</button>
</div>

<div id="view-game" class="container" style="display:none;">
    <div class="top-bar">
        <div class="btn-abort" onclick="game.abort()">
            <span>ğŸ </span> ABORT MISSION
        </div>
        <div id="audio-tag" class="audio-wave" onclick="soundSys.unlock()">AUDIO OFF</div>
    </div>

    <div class="hud">
        <div class="hud-item">
            <span class="hud-lbl">TARGET</span>
            <span class="hud-val"><span id="curr-q">1</span> / <span id="total-q">20</span></span>
        </div>
        <div class="hud-item">
            <span class="hud-lbl">SCORE</span>
            <span class="hud-val" id="score">0</span>
        </div>
    </div>

    <div class="viewport">
        <div class="scan-line"></div>
        <div class="loader" id="loader">
            <div>å®‡å®™è¨Šè™Ÿæ•æ‰ä¸­</div>
            <div style="font-size:0.6em; margin-top:5px; opacity:0.7;">ACQUIRING SIGNAL...</div>
        </div>
        <img id="main-img" class="target-image" alt="Deep Sky Object">
    </div>

    <button class="btn btn-report" onclick="game.reportError()">âš ï¸ åœ–ç‰‡ç„¡æ³•é¡¯ç¤º (é»æ­¤æ›é¡Œ)</button>

    <div id="options-box" class="options-grid"></div>

    <div id="feedback" class="feedback">
        <h3 id="fb-title" style="margin:0 0 5px 0;"></h3>
        <p id="fb-desc" style="margin:0; font-size:0.95em; color:#ddd; line-height:1.5;"></p>
        <button class="btn btn-main" style="margin-top:15px;" onclick="game.next()">CONTINUE âœ</button>
    </div>
</div>

<div id="view-end" class="container" style="display:none;">
    <h1 style="color:var(--primary);">MISSION COMPLETE</h1>
    <div style="font-size:5em; font-weight:bold; color:var(--primary); font-family:'Orbitron'; margin:20px 0; text-shadow:0 0 40px var(--primary);">
        <span id="final-score">0</span>
    </div>
    <p id="rank-text" style="font-size:1.2em; font-weight:bold; margin-bottom:30px;"></p>
    <button class="btn btn-main" onclick="location.reload()">REBOOT SYSTEM</button>
</div>

<script>
/**
 * ğŸµ Deep Space Generative Audio Engine (Ver 2.0)
 * åŒ…å«ï¼šDeep Drone (ä½é »), Ethereal Pads (ç©ºéˆå’Œå¼¦), Star Twinkles (æ˜Ÿå…‰éŸ³æ•ˆ)
 */
const soundSys = {
    ctx: null,
    masterGain: null,
    oscillators: [], // å„²å­˜ drone çš„æŒ¯ç›ªå™¨
    intervals: [],   // å„²å­˜è‡ªå‹•æ¼”å¥çš„è¨ˆæ™‚å™¨

    // ğŸŒŒ å®‡å®™éŸ³éš (A Minor Pentatonic + æ“´å……é«˜éŸ³ï¼Œç‡Ÿé€ ç©ºéˆæ„Ÿ)
    scale: [110, 130.81, 164.81, 196.00, 220, 261.63, 329.63, 392.00, 523.25, 659.25],

    // åˆå§‹åŒ–ä¸¦å•Ÿå‹•
    startDrone: function() {
        if (this.ctx) return; 
        
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
        
        this.masterGain = this.ctx.createGain();
        this.masterGain.gain.value = 0.3; // ä¸»éŸ³é‡é¿å…éå¤§
        this.masterGain.connect(this.ctx.destination);

        // 1. å•Ÿå‹•åº•å±¤ä½é »å—¡é³´ (Drone)
        this.createDroneOsc(55);    // A1 (åŸºç¤)
        this.createDroneOsc(55.5);  // å¾®èª¿ (ç”¢ç”Ÿ Binaural Beat æ‹é »)
        this.createDroneOsc(110, 0.05); // A2 (å¢åŠ åšåº¦)

        // 2. å•Ÿå‹•ç”Ÿæˆå¼éŸ³æ¨‚ (éš¨æ©Ÿæ¼”å¥)
        this.startGenerativeMusic();
        
        // UI æ›´æ–°
        const tag = document.getElementById('audio-tag');
        tag.innerText = "AUDIO ONLINE";
        tag.classList.add('active');
    },

    // å»ºç«‹æŒçºŒçš„ Drone éŸ³
    createDroneOsc: function(freq, vol = 0.1) {
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        
        osc.type = 'sine';
        osc.frequency.value = freq;
        
        g.gain.value = vol;
        
        osc.connect(g);
        g.connect(this.masterGain);
        
        osc.start();
        this.oscillators.push({node: osc, gain: g});
    },

    // ğŸ¹ å•Ÿå‹•è‡ªå‹•æ¼”å¥
    startGenerativeMusic: function() {
        // å¾ªç’°ï¼šæ¯ 4~7 ç§’æ¼”å¥ä¸€å€‹é•·éŸ³ (Pad)
        const padLoop = () => {
            if(!this.ctx) return;
            this.playAmbientPad();
            const nextTime = 4000 + Math.random() * 3000;
            this.intervals.push(setTimeout(padLoop, nextTime));
        };
        padLoop();

        // å¾ªç’°ï¼šæ¯ 2~10 ç§’éš¨æ©Ÿå‡ºç¾æ˜Ÿå…‰éŸ³æ•ˆ (Twinkle)
        const starLoop = () => {
            if(!this.ctx) return;
            if(Math.random() > 0.6) this.playStarTwinkle();
            const nextTime = 2000 + Math.random() * 8000;
            this.intervals.push(setTimeout(starLoop, nextTime));
        };
        starLoop();
    },

    // ğŸµ æ¼”å¥ä¸€å€‹æ¼¸å…¥æ¼¸å‡ºçš„é•·éŸ³ (æ¨¡æ“¬åˆæˆå™¨ Pad)
    playAmbientPad: function() {
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        
        // éš¨æ©Ÿé¸ä¸€å€‹éŸ³
        const freq = this.scale[Math.floor(Math.random() * this.scale.length)];
        
        osc.type = 'triangle'; // ä¸‰è§’æ³¢æ¯”è¼ƒæº«æ½¤
        osc.frequency.value = freq;
        
        // é€£æ¥
        osc.connect(g);
        g.connect(this.masterGain);

        // ADSR åŒ…çµ¡ç·š (æ¥µæ…¢çš„ Attack å’Œ Release)
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.08, t + 2); // 2ç§’æ¼¸å…¥
        g.gain.linearRampToValueAtTime(0, t + 8);    // 6ç§’æ¼¸å‡º

        osc.start(t);
        osc.stop(t + 8);
    },

    // âœ¨ æ¼”å¥æ¸…è„†çš„æ˜Ÿå…‰éŸ³
    playStarTwinkle: function() {
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();

        // é¸é«˜éŸ³
        const freq = this.scale[Math.floor(Math.random() * this.scale.length)] * 4; 
        
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq, t);
        
        osc.connect(g);
        g.connect(this.masterGain);

        // å¿«é€Ÿçš„ Attack/Release
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(0.05, t + 0.1);
        g.gain.exponentialRampToValueAtTime(0.001, t + 1.5);

        osc.start(t);
        osc.stop(t + 1.5);
    },

    // ğŸ›‘ åœæ­¢æ‰€æœ‰è²éŸ³
    stopDrone: function() {
        if (!this.ctx) return;
        
        // æ¸…é™¤æ‰€æœ‰è¨ˆæ™‚å™¨
        this.intervals.forEach(id => clearTimeout(id));
        this.intervals = [];

        // ç¸½éŸ³é‡æ·¡å‡º
        this.masterGain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 1);
        
        setTimeout(() => {
            this.oscillators.forEach(o => o.node.stop());
            this.ctx.close();
            this.ctx = null;
            this.oscillators = [];
        }, 1000);
        
        const tag = document.getElementById('audio-tag');
        tag.innerText = "AUDIO OFF";
        tag.classList.remove('active');
    },

    unlock: function() {
        if (this.ctx && this.ctx.state === 'suspended') {
            this.ctx.resume();
        }
    },

    // ğŸ® éŠæˆ²éŸ³æ•ˆ (SFX)
    playSFX: function(type) {
        if (!this.ctx) return;
        const t = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        osc.connect(g);
        g.connect(this.ctx.destination); // SFX ç›´æ¥è¼¸å‡ºï¼Œä¸å—èƒŒæ™¯éŸ³æ¨‚éŸ³é‡å½±éŸ¿å¤ªæ·±

        if (type === 'correct') {
            // é«˜ç§‘æŠ€ç¢ºèªéŸ³
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, t); 
            osc.frequency.exponentialRampToValueAtTime(1760, t + 0.1);
            g.gain.setValueAtTime(0.3, t);
            g.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
        } else if (type === 'wrong') {
            // éŒ¯èª¤è­¦ç¤º
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, t);
            osc.frequency.linearRampToValueAtTime(100, t + 0.3);
            g.gain.setValueAtTime(0.2, t);
            g.gain.linearRampToValueAtTime(0.001, t + 0.3);
        } else if (type === 'win') {
            // å‹åˆ©å’Œå¼¦
            this.playNote(523.25, t, 0.2); // C5
            this.playNote(659.25, t+0.1, 0.2); // E5
            this.playNote(783.99, t+0.2, 0.8); // G5
            return;
        }
        osc.start(t);
        osc.stop(t + 0.5);
    },

    playNote: function(freq, time, dur) {
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        osc.connect(g);
        g.connect(this.ctx.destination);
        osc.type = 'triangle';
        osc.frequency.value = freq;
        g.gain.setValueAtTime(0.1, time);
        g.gain.exponentialRampToValueAtTime(0.001, time + dur);
        osc.start(time);
        osc.stop(time + dur);
    }
};

/**
 * ğŸŒŒ é¡Œåº« (M1-M110 å®Œæ•´ä¸­æ–‡å + NGC)
 */
const DB_FULL = [];

const M_NAMES = {
    1:"èŸ¹ç‹€æ˜Ÿé›²",6:"è´è¶æ˜Ÿåœ˜",7:"æ‰˜å‹’å¯†æ˜Ÿåœ˜",8:"ç¤æ¹–æ˜Ÿé›²",11:"é‡é´¨æ˜Ÿåœ˜",13:"æ­¦ä»™åº§çƒç‹€æ˜Ÿåœ˜",
    16:"è€é·¹æ˜Ÿé›²",17:"å¥§ç±³åŠ æ˜Ÿé›²",20:"ä¸‰è£‚æ˜Ÿé›²",22:"äººé¦¬åº§çƒç‹€æ˜Ÿåœ˜",24:"äººé¦¬åº§æ†æ˜Ÿé›²",
    27:"å•éˆ´æ˜Ÿé›²",31:"ä»™å¥³åº§æ˜Ÿç³»",32:"æ©¢åœ“æ˜Ÿç³»",33:"ä¸‰è§’åº§æ˜Ÿç³»",40:"é›™æ˜Ÿ",42:"çµæˆ¶åº§å¤§æ˜Ÿé›²",
    43:"å¾·éº¥è˜­æ˜Ÿé›²",44:"èœ‚å·¢æ˜Ÿåœ˜",45:"æ˜´å®¿æ˜Ÿåœ˜",49:"æ©¢åœ“æ˜Ÿç³»",51:"æ¸¦ç‹€æ˜Ÿç³»",57:"ç’°ç‹€æ˜Ÿé›²",
    58:"èºæ—‹æ˜Ÿç³»",59:"æ©¢åœ“æ˜Ÿç³»",60:"æ©¢åœ“æ˜Ÿç³»",61:"èºæ—‹æ˜Ÿç³»",63:"å‘æ—¥è‘µæ˜Ÿç³»",64:"é»‘çœ¼æ˜Ÿç³»",
    74:"å¹½éˆæ˜Ÿç³»",76:"å°å•éˆ´æ˜Ÿé›²",78:"åå°„æ˜Ÿé›²",81:"æ³¢å¾·æ˜Ÿç³»",82:"é›ªèŒ„æ˜Ÿç³»",83:"å—é¢¨è»Šæ˜Ÿç³»",
    87:"å®¤å¥³Aæ˜Ÿç³»",97:"è²“é ­é·¹æ˜Ÿé›²",101:"é¢¨è»Šæ˜Ÿç³»",102:"ç´¡éŒ˜æ˜Ÿç³»",104:"è‰å¸½æ˜Ÿç³»"
};

for(let i=1; i<=110; i++) {
    let n = M_NAMES[i] || (i<=110 && [2,3,4,5,9,10,12,14,15,19,28,30,53,54,55,56,62,68,69,70,71,72,75,79,80,92,107].includes(i) ? "çƒç‹€æ˜Ÿåœ˜" : (i>=84&&i<=86||i>=88&&i<=91||i>=94&&i<=96||i>=98&&i<=100||i>=105&&i<=106||i>=108&&i<=110 ? "æ˜Ÿç³»" : "ç–æ•£æ˜Ÿåœ˜"));
    
    // æª”åè¦å‰‡
    let f = `Messier_${i}_Hubble_WikiSky.jpg`;
    if(i===1) f="Crab_Nebula.jpg";
    if(i===8) f="M8_Lagoon_Nebula_by_R_Vandbei.jpg";
    if(i===16) f="Eagle_Nebula_4.jpg";
    if(i===20) f="Trifid_Nebula_by_Deddy_Dayag.jpg";
    if(i===27) f="M27_-_Dumbbell_Nebula.jpg";
    if(i===31) f="M31_09-01-2011_(5438874637).jpg";
    if(i===42) f="Orion_Nebula_-_Hubble_2006_mosaic_18000.jpg";
    if(i===45) f="Pleiades_large.jpg";
    if(i===51) f="Messier51_sRGB.jpg";
    if(i===57) f="M57_The_Ring_Nebula.jpg";
    if(i===104) f="M104_ngc4594_sombrero_galaxy_hi-res.jpg";

    DB_FULL.push({ label: `M${i} ${n}`, file: f, desc: `æ¢…è¥¿è€¶ ${i} è™Ÿå¤©é«” (${n})` });
}

const NGCS = [
    { l:"NGC 2237 ç«ç‘°æ˜Ÿé›²", f:"The_Rosette_Nebula_Caldwell_49.jpg" },
    { l:"NGC 7293 èºæ—‹æ˜Ÿé›²", f:"Helix_Nebula_(NGC_7293).jpg" },
    { l:"NGC 6543 è²“çœ¼æ˜Ÿé›²", f:"NGC_6543.jpg" },
    { l:"NGC 6960 ç¶²ç‹€æ˜Ÿé›²", f:"Veil_Nebula_Supernova_Remnant.jpg" },
    { l:"IC 434 é¦¬é ­æ˜Ÿé›²", f:"Barnard_33.jpg" },
    { l:"NGC 7000 åŒ—ç¾æ´²æ˜Ÿé›²", f:"NGC7000_North_America_Nebula.jpg" },
    { l:"NGC 253 ç‰å¤«åº§æ˜Ÿç³»", f:"Sculptor_Galaxy_visible_VISTA.jpg" },
    { l:"NGC 5139 åŠäººé¦¬åº§Î©", f:"Omega_Centauri_by_ESO_VLT.jpg" },
    { l:"NGC 6302 è´è¶æ˜Ÿé›²", f:"NGC_6302_Hubble_2009.full.jpg" },
    { l:"NGC 602 å°éº¥å“²å€«æ˜Ÿåœ˜", f:"Hubble_Space_Telescope_image_of_NGC_602.jpg" }
];
NGCS.forEach(n => DB_FULL.push({ label: n.l, file: n.f, desc: n.l }));

const game = {
    pool: [],
    idx: 0,
    score: 0,
    targetCount: 0,
    answeredCount: 0,
    failSafe: 0,

    start: function() {
        this.targetCount = parseInt(document.getElementById('q-range').value);
        this.answeredCount = 0;
        this.score = 0;
        
        soundSys.startDrone(); // å•Ÿå‹•æ·±ç©ºéŸ³æ•ˆ
        this.shufflePool();
        
        document.getElementById('view-setup').style.display = 'none';
        document.getElementById('view-game').style.display = 'block';
        document.getElementById('view-end').style.display = 'none';
        document.getElementById('total-q').innerText = this.targetCount;
        
        this.loadQ();
    },

    // ğŸ  æ”¾æ£„ä»»å‹™
    abort: function() {
        if(confirm("ç¢ºå®šè¦æ”¾æ£„ç›®å‰ä»»å‹™ä¸¦è¿”å›åŸºåœ°å—ï¼Ÿ")) {
            soundSys.stopDrone();
            document.getElementById('view-game').style.display = 'none';
            document.getElementById('view-setup').style.display = 'block';
        }
    },

    shufflePool: function() {
        let arr = [...DB_FULL];
        for(let i=arr.length-1; i>0; i--) {
            const j = Math.floor(Math.random()*(i+1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        this.pool = arr;
        this.idx = 0;
    },

    loadQ: function() {
        if (this.answeredCount >= this.targetCount) return this.end();
        if (this.idx >= this.pool.length) this.idx = 0;

        const item = this.pool[this.idx];
        
        document.getElementById('curr-q').innerText = this.answeredCount + 1;
        document.getElementById('score').innerText = this.score;
        document.getElementById('feedback').style.display = 'none';
        document.getElementById('options-box').innerHTML = '';
        
        const img = document.getElementById('main-img');
        const loader = document.getElementById('loader');
        
        img.style.opacity = 0;
        loader.style.display = 'flex';
        
        // Proxy è¼‰å…¥
        img.src = `https://images.weserv.nl/?url=commons.wikimedia.org/wiki/Special:FilePath/${item.file}&w=800&output=jpg`;
        
        img.onload = () => {
            loader.style.display = 'none';
            img.style.opacity = 1;
            this.failSafe = 0;
        };
        
        // ğŸ”‡ éœé»˜è·³éï¼Œä¸å½ˆçª—
        img.onerror = () => {
            console.log("Skip bad img:", item.label);
            this.failSafe++;
            if (this.failSafe > 20) return; 
            this.idx++;
            this.loadQ();
        };
        
        this.genOpts(item);
    },

    reportError: function() {
        this.idx++;
        this.loadQ();
    },

    genOpts: function(correct) {
        const box = document.getElementById('options-box');
        box.innerHTML = '';
        
        let opts = [correct];
        while(opts.length < 4) {
            const r = DB_FULL[Math.floor(Math.random() * DB_FULL.length)];
            if(!opts.find(x => x.label === r.label)) opts.push(r);
        }
        opts.sort(() => 0.5 - Math.random());

        opts.forEach(o => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-opt';
            btn.innerText = o.label;
            btn.onclick = () => this.check(btn, o.label);
            box.appendChild(btn);
        });
    },

    check: function(btn, ans) {
        const correct = this.pool[this.idx];
        const isRight = (ans === correct.label);
        
        document.querySelectorAll('.btn-opt').forEach(b => {
            b.disabled = true;
            if(b.innerText === correct.label) {
                b.style.background = 'rgba(0, 243, 255, 0.2)';
                b.style.borderColor = 'var(--primary)';
            } else if(b === btn && !isRight) {
                b.style.background = 'rgba(255, 0, 85, 0.2)';
                b.style.borderColor = 'var(--danger)'; 
            }
        });

        const fb = document.getElementById('feedback');
        fb.style.display = 'block';
        if(isRight) {
            this.score += 100;
            soundSys.playSFX('correct');
            document.getElementById('score').innerText = this.score;
            fb.className = 'feedback';
            document.getElementById('fb-title').innerText = "âœ… è¾¨è­˜æˆåŠŸ";
            document.getElementById('fb-title').style.color = "var(--primary)";
        } else {
            soundSys.playSFX('wrong');
            fb.className = 'feedback wrong';
            document.getElementById('fb-title').innerText = "âš ï¸ è¾¨è­˜éŒ¯èª¤";
            document.getElementById('fb-title').style.color = "#ff3366"; 
        }
        document.getElementById('fb-desc').innerText = correct.desc;
    },

    next: function() {
        this.idx++;
        this.answeredCount++;
        this.loadQ();
    },

    end: function() {
        soundSys.playSFX('win');
        soundSys.stopDrone(); // çµæŸæ™‚åœæ­¢èƒŒæ™¯éŸ³
        document.getElementById('view-game').style.display = 'none';
        document.getElementById('view-end').style.display = 'block';
        document.getElementById('final-score').innerText = this.score;
        
        const rank = document.getElementById('rank-text');
        const max = this.targetCount * 100;
        if (this.score >= max * 0.9) rank.innerText = "ç¨±è™Ÿï¼šå‚³å¥‡è§€æ¸¬å“¡";
        else if (this.score >= max * 0.6) rank.innerText = "ç¨±è™Ÿï¼šè³‡æ·±å¤©æ–‡å®˜";
        else rank.innerText = "ç¨±è™Ÿï¼šå¯¦ç¿’å­¸å“¡";
    }
};
</script>
</body>

</html>
